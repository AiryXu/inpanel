<div navbar ng-init="currentItem='site.apache'"></div>
<div ng-show="!loaded">
    <div loading></div>
</div>

<div id="main" ng-show="loaded" style="display:none;">
    <div class="module-header">
        <h3>{{module_header}}</h3>
    </div>

    <div class="alert alert-danger" ng-show="!gen_by_inpanel" style="display:none;">
        <p>该站点的配置不是使用 InPanel 生成的，继续配置有可能导致部分配置丢失。</p>
        <p>建议使用 InPanel 为该站点新建一个配置，并将原配置迁移过来。</p>
        <p>如要手工编辑原始配置文件内容，请<a href="#/service/apache?s=configfile">点击这里</a>。</p>
    </div>

    <div class="tabbable" ng-init="load()">
        <ul class="nav nav-tabs">
            <li ng-class="'active' | iftrue:activeTabName=='basic'"><a href="#basic" ng-click="sec('basic')" data-toggle="tab">基本信息</a></li>
            <li ng-class="'active' | iftrue:activeTabName=='alias'"><a href="#alias" ng-click="sec('alias')" data-toggle="tab">绑定别名</a></li>
            <li ng-class="'active' | iftrue:activeTabName=='directory'"><a href="#directory" ng-click="sec('directory')" data-toggle="tab">路径设置</a></li>
            <li ng-class="'active' | iftrue:activeTabName=='advanced'"><a href="#advanced" ng-click="sec('advanced')" data-toggle="tab">高级设置</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane" ng-class="'active' | iftrue:activeTabName=='basic'" id="basic">
                <div class="form-horizontal form-horizontal-small">
                    <div class="form-group form-inline">
                        <label class="col-sm-2 control-label">监听地址</label>
                        <div class="col-sm-10">
                            <input class="form-control" ng-model="setting.IP" type="text" placeholder="默认监听所有可用IP">
                        </div>
                    </div>
                    <div class="form-group form-inline">
                        <label class="col-sm-2 control-label">监听端口</label>
                        <div class="col-sm-10">
                            <div class="input-group">
                                <input class="form-control" ng-model="setting.port" type="text" placeholder="监听端口">
                                <div class="input-group-btn">
                                    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">端口 <span class="caret"></span></button>
                                    <ul class="dropdown-menu dropdown-menu-right">
                                        <li><a href="javascript:void(0);" ng-click="setting.port='80'">80</a></li>
                                        <li><a href="javascript:void(0);" ng-click="setting.port='81'">81</a></li>
                                        <li><a href="javascript:void(0);" ng-click="setting.port='443'">443</a></li>
                                        <li><a href="javascript:void(0);" ng-click="setting.port='8080'">8080</a></li>
                                        <li><a href="javascript:void(0);" ng-click="setting.port='8899'">8899</a></li>
                                        <li><a href="javascript:void(0);" ng-click="setting.port='9090'">9090</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group form-inline">
                        <label class="col-sm-2 control-label">网站域名</label>
                        <div class="col-sm-10">
                            <input ng-model="setting.ServerName" type="text" class="form-control" placeholder="网站域名">
                        </div>
                    </div>
                    <div class="form-group form-inline">
                        <label class="col-sm-2 control-label">文档位置</label>
                        <div class="col-sm-10">
                            <div class="input-group">
                                <input ng-model="setting.DocumentRoot" type="text" class="form-control" placeholder="网站存放目录">
                                <div class="input-group-btn">
                                    <button class="btn btn-default" ng-click="selectsslcrt()" title="选择文件夹"><i class="glyphicon glyphicon-file"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">默认首页</label>
                        <div class="col-sm-10">
                            <input class="form-control" ng-model="setting.DirectoryIndex" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">错误日志</label>
                        <div class="col-sm-10">
                            <input class="form-control" ng-model="setting.ErrorLog" type="text">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">CustomLog</label>
                        <div class="col-sm-10">
                            <input class="form-control" ng-model="setting.CustomLog" type="text">
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" ng-class="'active' | iftrue:activeTabName=='alias'" id="alias">
                <div class="form-horizontal form-horizontal-small">
                    <div class="form-group form-inline">
                        <div class="form-inline" ng-repeat="server_name in setting.alias">
                            <button class="btn btn-default" ng-click="add_alias($index)" ng-show="setting.locations.length==0" style="display:none">
                                <i class="glyphicon glyphicon-plus"></i> 添加域名
                            </button>
                            <div class="input-group">
                                <input class="form-control" ng-model="server_name" type="text" placeholder="请输入域名">
                                <div class="input-group-btn">
                                    <button class="btn btn-default" title="删除这个别名" ng-click="delete_alias($index)"><i class="glyphicon glyphicon-minus"></i></button>
                                    <button class="btn btn-default" title="增加一个别名" ng-click="add_alias()"><i class="glyphicon glyphicon-plus"></i></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" ng-class="'active' | iftrue:activeTabName=='directory'" id="directory">
                <div class="form-horizontal form-horizontal-small">
                    <div class="form-group">
                        <label class="col-sm-2 control-label">路径设置</label>
                        <div class="col-sm-10">
                            <div class="form-inline">
                                <button class="btn btn-default" ng-click="add_directory($index)" ng-show="setting.directory.length==0" style="display:none">
                                    <i class="glyphicon glyphicon-plus"></i> 添加路径配置
                                </button>
                                <ul class="nav nav-tabs" ng-show="setting.directory.length>0" style="display:none;">
                                    <li ng-repeat="location in setting.directory" ng-class="'active'|iftrue:$index==curloc" ng-click="setdir($index)">
                                        <a href="#loc_{{$index}}" data-toggle="tab">{{location.urlpath}}</a>
                                    </li>
                                    <li>
                                        <button class="btn btn-default" ng-click="add_directory()" style="margin-left: 20px; margin-top: 5px;">
                                            <i class="glyphicon glyphicon-plus"></i> 添加路径
                                        </button>
                                        <button class="btn btn-default" ng-click="deletelocation(curloc)" style="margin-left: 10px; margin-top: 5px;">
                                            <i class="glyphicon glyphicon-minus"></i> 删除路径
                                        </button>
                                    </li>
                                </ul>
                                <div class="tab-content" ng-show="setting.directory.length>0" style="display:none;">
                                    <div class="tab-pane" ng-repeat="location in setting.directory" ng-class="'active'|iftrue:$index==curloc" id="loc_{{$index}}">
                                        <div class="form-inline">
                                            <label class="col-sm-2 control-label">URL路径</label>
                                            <div class="controls">
                                                <input class="form-control" ng-model="location.urlpath" ng-change="urlpathchange(location)" type="text" placeholder="URL路径">
                                            </div>
                                        </div>
                                        <div class="form-inline">
                                            <label class="col-sm-2 control-label">引擎类别</label>
                                            <div class="controls">
                                                <select class="form-control" ng-model="location.engine">
                                                    <option value="static">纯静态</option>
                                                    <option value="fastcgi">FastCGI(PHP)</option>
                                                    <option value="redirect">跳转</option>
                                                    <option value="proxy">反向代理</option>
                                                    <option value="error">返回错误</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='static'">
                                            <label class="col-sm-2 control-label">指定目录</label>
                                            <div class="controls">
                                                <div class="input-group">
                                                    <input ng-model="location.static.root" type="text" class="form-control" placeholder="路径所访问的目录">
                                                    <span class="input-group-btn">
                                                        <button class="btn btn-default" ng-click="selectstaticfolder($index)">
                                                            <i class="glyphicon glyphicon-folder-open"></i>
                                                        </button>
                                                    </span>
                                                </div>
                                                <p>
                                                    <label class="checkbox-inline"><input ng-model="location.static.autocreate" type="checkbox"> 目录不存在时，自动创建目录</label><br>
                                                    <label class="checkbox-inline"><input ng-model="location.static.autoindex" type="checkbox"> 开启目录自动索引</label>
                                                </p>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='fastcgi'">
                                            <label class="col-sm-2 control-label">指定目录</label>
                                            <div class="controls">
                                                <div class="input-group">
                                                    <input class="form-control" ng-model="location.fastcgi.root" type="text" placeholder="路径所访问的目录">
                                                    <span class="input-group-btn">
                                                        <button class="btn btn-default" ng-click="selectfastcgifolder($index)">
                                                            <i class="glyphicon glyphicon-folder-open"></i>
                                                        </button>
                                                    </span>
                                                </div>
                                                <p><label class="checkbox-inline"><input ng-model="location.fastcgi.autocreate" type="checkbox">目录不存在时，自动创建目录</label></p>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='fastcgi'">
                                            <label class="col-sm-2 control-label">FastCGI</label>
                                            <div class="controls">
                                                <input class="form-control" ng-model="location.fastcgi.fastcgi_pass" type="text" placeholder="FastCGI服务器地址">
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='redirect'">
                                            <label class="col-sm-2 control-label">跳转地址</label>
                                            <div class="controls">
                                                <input class="form-control" ng-model="location.redirect.url" type="text" placeholder="要跳转到的URL地址">
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='redirect'">
                                            <label class="col-sm-2 control-label">跳转类型</label>
                                            <div class="controls">
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.redirect.type" value="301"> 301永久重定向
                                                </label>
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.redirect.type" value="302"> 302临时重定向
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='redirect'">
                                            <label class="col-sm-2 control-label">路径处理</label>
                                            <div class="controls">
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.redirect.option" value="keep"> 保留请求路径
                                                </label>
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.redirect.option" value="ignore"> 忽略请求路径
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='proxy'">
                                            <label class="col-sm-2 control-label">后端协议</label>
                                            <div class="controls">
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.proxy.protocol" value="http"> http
                                                </label>
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.proxy.protocol" value="https"> https
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='proxy'">
                                            <label class="col-sm-2 control-label">主机域名</label>
                                            <div class="controls">
                                                <input ng-model="location.proxy.host" type="text" class="form-control" placeholder="后端的域名，如：www.baidu.com">
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='proxy'">
                                            <label class="col-sm-2 control-label">真实IP</label>
                                            <div class="controls">
                                                <label class="checkbox-inline">
                                                    <input type="checkbox" ng-model="location.proxy.realip"> 传递客户端真实IP（X-Real-IP）
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='proxy'">
                                            <label class="col-sm-2 control-label">后端编码</label>
                                            <div class="controls">
                                                <select class="form-control" ng-model="location.proxy.charset">
                                                    <option value="">默认</option>
                                                    <option value="utf-8">UTF-8</option>
                                                    <option value="gb2312">GB2312</option>
                                                    <option value="gbk">GBK</option>
                                                    <option value="gb18030">GB18030</option>
                                                    <option value="big5">BIG5</option>
                                                    <option value="euc-jp">EUC-JP</option>
                                                    <option value="euc-kr">EUC-KR</option>
                                                    <option value="iso-8859-2">ISO-8859-2</option>
                                                    <option value="shift_jis">Shift_JIS</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div ng-show="location.engine=='proxy'" ng-repeat="backend in location.proxy.backends">
                                            <div class="form-inline">
                                                <label class="col-sm-2 control-label"><span ng-show="$index==0">代理后端</span></label>
                                                <div class="controls">
                                                    <input ng-model="backend.server" type="text" class="form-control" placeholder="格式为：IP:端口 或 域名:端口">
                                                    <input ng-model="backend.weight" type="text" class="form-control" placeholder="权重值" ng-show="location.proxy.backends.length>1&&location.proxy.balance=='weight'">
                                                    <button class="btn btn-default" title="删除该后端" ng-click="proxy_deletebackend($parent.$index, $index)" ng-show="location.proxy.backends.length>1"><i class="glyphicon glyphicon-minus"></i></button>
                                                    <button class="btn btn-default" title="增加一个后端" ng-click="proxy_addbackend($parent.$index)" ng-show="$index==location.proxy.backends.length-1"><i class="glyphicon glyphicon-plus"></i></button>
                                                </div>
                                            </div>
                                            <div class="form-inline" ng-show="location.proxy.backends.length>1">
                                                <div class="controls">
                                                    失效条件：<input ng-model="backend.fail_timeout" type="text" class="form-control"> 秒内失败
                                                    <input ng-model="backend.max_fails" type="text" class="form-control"> 次
                                                </div>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='proxy'&&location.proxy.backends.length>1">
                                            <label class="col-sm-2 control-label">负载均衡</label>
                                            <div class="controls">
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.proxy.balance" value="weight"> 按权重分配
                                                </label>
                                                <label class="radio-inline">
                                                    <input type="radio" ng-model="location.proxy.balance" value="ip_hash"> 根据IP自动分配
                                                </label>
                                                <label class="radio-inline" ng-show="true | ifverget:[apache_version, '1.3.1']">
                                                    <input type="radio" ng-model="location.proxy.balance" value="least_conn"> 最少连接优先分配
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='proxy'&&location.proxy.backends.length>1">
                                            <label class="col-sm-2 control-label">保持连接</label>
                                            <div class="controls">
                                                <input ng-model="location.proxy.keepalive" type="text" class="form-control" placeholder="到后端保持的连接数">
                                                <span class="help-block">这里设置的是保持连接的最大数量，而不是允许连接的数量，最大连接数量不受限制。</span>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.engine=='proxy'">
                                            <label class="col-sm-2 control-label">缓存设置</label>
                                            <div class="controls">
                                                <label class="checkbox-inline">
                                                    <input type="checkbox" ng-model="location.proxy.proxy_cache_enable"> 启用反向代理缓存
                                                </label>
                                            </div>
                                        </div>
                                        <div ng-show="location.engine=='proxy'&&location.proxy.proxy_cache_enable">缓存区域</div>
                                        <div class="form-inline" ng-show="location.engine=='error'">
                                            <label class="col-sm-2 control-label">错误代码</label>
                                            <div class="controls">
                                                <select class="form-control" ng-model="location.error.code">
                                                    <option value="401">401 - 未授权的访问</option>
                                                    <option value="403">403 - 禁止访问</option>
                                                    <option value="404">404 - 页面无法找到</option>
                                                    <option value="500">500 - 服务器内部错误</option>
                                                    <option value="502">502 - 网关错误</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="form-inline" style="margin-top:5px;margin-bottom:0" ng-show="location.engine=='static'">
                                            <label class="col-sm-2 control-label">Rewrite</label>
                                            <div class="controls">
                                                <label class="checkbox-inline">
                                                    <input ng-model="location.static.rewrite_enable" ng-disabled="processing" type="checkbox"> 在该路径下启用 Rewrite
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.static.rewrite_enable" style="display:none">
                                            <div class="controls">
                                                <label class="checkbox-inline">
                                                    <input ng-model="location.static.rewrite_detect_file" ng-disabled="processing" type="checkbox"> 仅当文件不存在时启用 Rewrite
                                                </label><br>
                                                <textarea ng-model="location.static.rewrite_rules" style="width:400px;height:100px;margin-top:5px;">
                                                </textarea>
                                                <br><a href="https://docs.inpanel.org/?sec=apache_rewrite" target="_blank">常用 Rewrite 规则参考</a>
                                            </div>
                                        </div>
                                        <div class="form-inline" style="margin-top:5px;margin-bottom:0" ng-show="location.engine=='fastcgi'">
                                            <label class="col-sm-2 control-label">Rewrite</label>
                                            <div class="controls">
                                                <label class="checkbox-inline">
                                                    <input ng-model="location.fastcgi.rewrite_enable" ng-disabled="processing" type="checkbox"> 在该路径下启用 Rewrite
                                                </label>
                                            </div>
                                        </div>
                                        <div class="form-inline" ng-show="location.fastcgi.rewrite_enable" style="display:none">
                                            <div class="controls">
                                                <label class="checkbox-inline">
                                                    <input ng-model="location.fastcgi.rewrite_detect_file" ng-disabled="processing" type="checkbox">
                                                    仅当文件不存在时启用 Rewrite
                                                </label><br>
                                                <textarea ng-model="location.fastcgi.rewrite_rules" style="width:400px;height:100px;margin-top:5px;">
                                                </textarea>
                                                <br><a href="https://docs.inpanel.org/?sec=apache_rewrite" target="_blank">常用 Rewrite 规则参考</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="tab-pane" ng-class="'active' | iftrue:activeTabName=='advanced'" id="advanced">
                <div class="form-horizontal form-horizontal-small">
                    <div class="form-group form-inline">
                        <label class="col-sm-2 control-label">下载限制</label>
                        <div class="col-sm-10">
                            <div class="input-group">
                                <input class="form-control" ng-model="setting.limit_rate" type="text" placeholder="不限制">
                                <span class="input-group-addon">KB / S</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group form-inline">
                        <label class="col-sm-2 control-label">连接限制</label>
                        <div class="col-sm-10">
                            <div class="input-group">
                                <input class="form-control" ng-model="setting.limit_conn" type="text" placeholder="不限制">
                                <span class="input-group-addon">个 / IP</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="col-sm-2 control-label">SSL 选项</label>
                        <div class="col-sm-10">
                            <div class="alert alert-info">
                                <p>同服务器上配置多个SSL站点需要分别指定独立IP</p>
                                <p>考虑到安全性，请勿将SSL证书和密码放在WEB目录下</p>
                            </div>
                            <div class="form-group form-inline">
                                <label class="col-sm-2 control-label">SSL证书</label>
                                <div class="input-group">
                                    <input ng-model="setting.ssl_crt" type="text" class="form-control" placeholder="SSL证书文件">
                                    <div class="input-group-btn">
                                        <button class="btn btn-default" ng-click="selectsslcrt()" title="选择文件"><i class="glyphicon glyphicon-file"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div class="form-group form-inline">
                                <label class="col-sm-2 control-label">SSL密钥</label>
                                <div class="input-group">
                                    <input ng-model="setting.ssl_key" type="text" class="form-control" placeholder="SSL密钥文件">
                                    <div class="input-group-btn">
                                        <button class="btn btn-default" ng-click="selectsslkey()" title="选择文件"><i class="glyphicon glyphicon-file"></i></button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-2 control-label">Rewrite</label>
                        <div class="col-sm-10">
                            <label class="checkbox-inline"><input ng-model="setting.rewrite_enable" type="checkbox"> 启用全局 Rewrite</label>
                            <div class="form-inline" ng-show="setting.rewrite_enable" style="margin-top:10px;display:none">
                                <select class="form-control" ng-model="rewrite_template">
                                    <option value="">常用 Rewrite 规则</option>
                                    <option value="301_1">301跳转，保留原路径</option>
                                    <option value="301_2">301跳转，不保留原路径</option>
                                    <option value="302_1">302跳转，保留原路径</option>
                                    <option value="302_2">302跳转，不保留原路径</option>
                                </select><br>
                                <textarea class="form-control" ng-model="setting.rewrite_rules" style="width:400px;height:100px;margin-top:15px;"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <hr/>
        <p>
            <button class="btn btn-primary" ng-click="submit()">提交</button>
            <button class="btn btn-success" ng-click="submit('active')">生效</button>
            <button class="btn btn-warning" ng-show="action=='edit'" ng-click="restore()">重置</button>
            <a class="btn btn-default" href="#/site?s=apache">取消</a>
        </p>
    </div>
</div>

<div id="selector" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h3>{{selector_title}}</h3>
            </div>
            <div class="modal-body">
                <div selector></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">取消</button>
            </div>
        </div>
    </div>
</div>